{
	"AWSTemplateFormatVersion": "2010-09-09",
	"Description": "(v8.1) AWS CFT to deploy a standalone FortiAnalyzer into an existing VPC",
	"Metadata": {
		"AWS::CloudFormation::Interface": {
			"ParameterGroups": [
				{
					"Label": {
						"default": "VPC Configuration"
					},
					"Parameters": [
						"VPCID",
						"VPCCIDR",
						"Subnet"
					]
				},
				{
					"Label": {
						"default": "FortiAnalyzer Instance Configuration"
					},
					"Parameters": [
						"InstanceType",
						"CIDRForInstanceAccess",
						"KeyPair",
						"EncryptVolumes",
						"PubliclyAvailable",
						"S3EndpointDeployment",
						"SubnetRouteTableID",
						"FortiAnalyzerVersion",
						"LicenseType",
						"InitS3Bucket",
						"FortiAnalyzerLicenseFile",
						"FortiAnalyzerFortiFlexToken"
					]
				},
				{
					"Label": {
						"default": "FortiAnalyzer Interface IP Configuration"
					},
					"Parameters": [
						"FortiAnalyzerIP"
					]
				}
			]
		}
	},
	"Parameters": {
		"VPCID": {
			"Type": "AWS::EC2::VPC::Id",
			"Description": "Select the VPC to use"
		},
		"VPCCIDR": {
			"Type": "String",
			"Default": "10.0.0.0/16",
			"Description": "Provide a network CIDR for the VPC",
			"AllowedPattern": "(\\d{1,3}\\.){3}\\d{1,3}/\\d{1,2}",
			"ConstraintDescription": "Must be a valid CIDR block format."
		},
		"Subnet": {
			"Type": "AWS::EC2::Subnet::Id",
			"Description": "Select the subnet to deploy the FortiAnalyzer into"
		},
		"FortiAnalyzerIP": {
			"Type": "String",
			"Default": "10.0.1.10/24",
			"Description": "Provide the IP address in CIDR form for the FortiAnalyzer to use",
			"AllowedPattern": "(\\d{1,3}\\.){3}\\d{1,3}/\\d{1,2}",
			"ConstraintDescription": "Must be a valid CIDR block format."
		},
		"PubliclyAvailable": {
			"Type": "String",
			"Default": "Yes",
			"Description": "Select if the FAZ will have a EIP to be publicly available or not.  *** If you select No, then an S3 endpoint needs to be deployed and reachable from the subnet the FortiAnalyzer is in to successfully bootstrap.  Also, PAYG licensed instances require internet access to register with FortiCare successfully. ***",
			"AllowedValues": [
				"Yes",
				"No"
			]
		},
		"InstanceType": {
			"Type": "String",
			"Default": "m6i.2xlarge",
			"Description": "Select the instance type for the FortiAnalyzer.  *** If using PAYG2Devices for LicenseType, you can only use up to a m5.xlarge ***",
			"AllowedValues": [
				"m5.2xlarge",
				"m5.4xlarge",
				"m5.8xlarge",
				"m5.16xlarge",
				"m6a.2xlarge",
				"m6a.4xlarge",
				"m6a.8xlarge",
				"m6a.16xlarge",
				"m6i.2xlarge",
				"m6i.4xlarge",
				"m6i.8xlarge",
				"m6i.16xlarge",
				"m7a.2xlarge",
				"m7a.4xlarge",
				"m7a.8xlarge",
				"m7a.16xlarge"
			]
		},
		"CIDRForInstanceAccess": {
			"Type": "String",
			"Description": "Provide a network CIDR from which the FortiAnalyzer instance will be accessed",
			"AllowedPattern": "(\\d{1,3}\\.){3}\\d{1,3}/\\d{1,2}",
			"ConstraintDescription": "Must be a valid CIDR block format."
		},
		"KeyPair": {
			"Type": "AWS::EC2::KeyPair::KeyName",
			"Description": "Select a keypair to associate with the FortiAnalyzer"
		},
		"EncryptVolumes": {
			"Type": "String",
			"Description": "Select 'true' to encrypt the FortiAnalyzer instances OS and Log volumes with your account's KMS default master key for EBS.  Otherwise select false to leave unencrypted",
			"AllowedValues": [
				"true",
				"false"
			]
		},
		"S3EndpointDeployment": {
			"Type": "String",
			"Description": "Select if a new S3 Endpoint should be deployed or not. If you used the BaseVPC template then select UseExisting.  *** If the FortiAnalyzer does not have direct internet access, an S3 Endpoint should be used and associated to the subnet the FortiAnalyzer will be deployed in for successful bootstrapping ***",
			"AllowedValues": [
				"DeployNew",
				"UseExisting"
			]
		},
		"SubnetRouteTableID": {
			"Type": "String",
			"Description": "If a new S3 Endpoint is to be deployed, provide the route table ID associated with the subnet the FortiAnalyzer will be deployed in."
		},
		"InitS3Bucket": {
			"Type": "String",
			"Description": "[BYOL Only, leave blank otherwise] Provide the Init S3 Bucket name, where your config files will be created  *** the bucket should exist in the same region as this deployment for successful bootstrapping ***"
		},
		"FortiAnalyzerVersion": {
			"Type": "String",
			"Default": "7.6.x",
			"Description": "Select the verion of FortiAnalyzer to use (latest GA AMI will be used)",
			"AllowedValues": [
				"7.2.x",
				"7.4.x",
				"7.6.x"
			]
		},
		"LicenseType": {
			"Type": "String",
			"Description": "Select the license type for the FortiAnalyzer. *** PAYGSCALE is only available with 7.6.x ***",
			"AllowedValues": [
				"BYOL",
				"Flex",
				"PAYGSCALE",
				"PAYG2Devices",
				"PAYG10Devices",
				"PAYG30Devices",
				"PAYG100Devices",
				"PAYG500Devices"
			]
		},
		"FortiAnalyzerLicenseFile": {
			"Type": "String",
			"Description": "[BYOL Only, leave blank for PAYG] Provide the name of the BYOL license file in the Init S3 Bucket for the FortiAnalyzer (ie faz.lic or prefix/faz.lic)"
		},
		"FortiAnalyzerFortiFlexToken": {
			"Type": "String",
			"Description": "[Flex Only, leave blank otherwise] Provide the FortiFlex Token for the FortiAnalyzer (ie 1A2B3C4D5E6F7G8H9I0J)"
		}
	},
	"Mappings": {
		"FortiAnalyzerAMISearchString": {
			"7.2.x": {
				"BYOL": "FortiAnalyzer-VM64-AWS *(7.2.*)*|9ipdy7tpkp24kmfsjgfuymny1",
				"Flex": "FortiAnalyzer-VM64-AWS *(7.2.*)*|9ipdy7tpkp24kmfsjgfuymny1",
				"PAYG2Devices": "FortiAnalyzer-VM64-AWSOnDemand *(7.2.*)*|9dtuu71e8jl604ce11efi1mzo",
				"PAYG10Devices": "FortiAnalyzer-VM64-AWSOnDemand *(7.2.*)*|5fjrlla50pzzq1c8064gnm11n",
				"PAYG30Devices": "FortiAnalyzer-VM64-AWSOnDemand *(7.2.*)*|f260v7j9fwdvlcsbnpsjpaozc",
				"PAYG100Devices": "FortiAnalyzer-VM64-AWSOnDemand *(7.2.*)*|3nlrca0hphlsq7bl6v99smx10",
				"PAYG500Devices": "FortiAnalyzer-VM64-AWSOnDemand *(7.2.*)*|dlwisgg79vzzo3zeommthp0zv"
			},
			"7.4.x": {
				"BYOL": "FortiAnalyzer-VM64-AWS *(7.4.*)*|9ipdy7tpkp24kmfsjgfuymny1",
				"Flex": "FortiAnalyzer-VM64-AWS *(7.4.*)*|9ipdy7tpkp24kmfsjgfuymny1",
				"PAYG2Devices": "FortiAnalyzer-VM64-AWSOnDemand *(7.4.*)*|9dtuu71e8jl604ce11efi1mzo",
				"PAYG10Devices": "FortiAnalyzer-VM64-AWSOnDemand *(7.4.*)*|5fjrlla50pzzq1c8064gnm11n",
				"PAYG30Devices": "FortiAnalyzer-VM64-AWSOnDemand *(7.4.*)*|f260v7j9fwdvlcsbnpsjpaozc",
				"PAYG100Devices": "FortiAnalyzer-VM64-AWSOnDemand *(7.4.*)*|3nlrca0hphlsq7bl6v99smx10",
				"PAYG500Devices": "FortiAnalyzer-VM64-AWSOnDemand *(7.4.*)*|dlwisgg79vzzo3zeommthp0zv"
			},
			"7.6.x": {
				"BYOL": "FortiAnalyzer-VM64-AWS *(7.6.*)*|9ipdy7tpkp24kmfsjgfuymny1",
				"Flex": "FortiAnalyzer-VM64-AWS *(7.6.*)*|9ipdy7tpkp24kmfsjgfuymny1",
				"PAYGSCALE": "FortiAnalyzer-VM64-AWSONDEMAND *(7.6.*)*|cec7udm5mw3mt09v83hmjmz5p",
				"PAYG2Devices": "FortiAnalyzer-VM64-AWSONDEMAND *(7.6.*)*|9dtuu71e8jl604ce11efi1mzo",
				"PAYG10Devices": "FortiAnalyzer-VM64-AWSONDEMAND *(7.6.*)*|5fjrlla50pzzq1c8064gnm11n",
				"PAYG30Devices": "FortiAnalyzer-VM64-AWSONDEMAND *(7.6.*)*|f260v7j9fwdvlcsbnpsjpaozc",
				"PAYG100Devices": "FortiAnalyzer-VM64-AWSONDEMAND *(7.6.*)*|3nlrca0hphlsq7bl6v99smx10",
				"PAYG500Devices": "FortiAnalyzer-VM64-AWSONDEMAND *(7.6.*)*|dlwisgg79vzzo3zeommthp0zv"
			}
		}
	},
	"Conditions": {
		"BYOL": {
			"Fn::Equals": [
				{
					"Ref": "LicenseType"
				},
				"BYOL"
			]
		},
		"FortiFlex": {
			"Fn::Equals": [
				{
					"Ref": "LicenseType"
				},
				"Flex"
			]
		},
		"CreateS3Endpoint": {
			"Fn::Equals": [
				{
					"Ref": "S3EndpointDeployment"
				},
				"DeployNew"
			]
		},
		"CreateEIP": {
			"Fn::Equals": [
				{
					"Ref": "PubliclyAvailable"
				},
				"Yes"
			]
		}
	},
	"Resources": {
		"S3Endpoint": {
			"Type": "AWS::EC2::VPCEndpoint",
			"Condition": "CreateS3Endpoint",
			"Properties": {
				"PolicyDocument": {
					"Version": "2012-10-17",
					"Statement": [
						{
							"Effect": "Allow",
							"Principal": "*",
							"Action": [
								"s3:GetObject"
							],
							"Resource": [
								"*"
							]
						}
					]
				},
				"RouteTableIds": [
					{
						"Ref": "SubnetRouteTableID"
					}
				],
				"ServiceName": {
					"Fn::Sub": "com.amazonaws.${AWS::Region}.s3"
				},
				"VpcId": {
					"Ref": "VPCID"
				}
			}
		},
		"InstanceRole": {
			"Type": "AWS::IAM::Role",
			"Properties": {
				"AssumeRolePolicyDocument": {
					"Version": "2012-10-17",
					"Statement": [
						{
							"Effect": "Allow",
							"Principal": {
								"Service": [
									"ec2.amazonaws.com"
								]
							},
							"Action": [
								"sts:AssumeRole"
							]
						}
					]
				},
				"Path": "/",
				"Policies": [
					{
						"PolicyName": "FGCPPolicy",
						"PolicyDocument": {
							"Version": "2012-10-17",
							"Statement": [
								{
									"Sid": "BootStrapFromS3",
									"Effect": "Allow",
									"Action": [
										"s3:GetObject"
									],
									"Resource": "*"
								},
								{
									"Sid": "FazHA7mr4p2orNewer",
									"Effect": "Allow",
									"Action": [
										"ec2:AssignPrivateIpAddresses",
										"ec2:DescribeSubnets",
										"ec2:DescribeNetworkInterfaces",
										"ec2:DescribeAddresses",
										"ec2:AssociateAddress",
										"ec2:CreateTags"
									],
									"Resource": "*"
								},
								{
									"Sid": "SDNConnectorFortiView",
									"Effect": "Allow",
									"Action": [
										"ec2:DescribeInstances",
										"ec2:DescribeRegions",
										"ec2:DescribeVpcEndpoints",
										"eks:DescribeCluster",
										"eks:ListClusters",
										"inspector:DescribeFindings",
										"inspector:ListFindings"
									],
									"Resource": "*"
								}
							]
						}
					}
				]
			}
		},
		"InstanceProfile": {
			"Type": "AWS::IAM::InstanceProfile",
			"Properties": {
				"Path": "/",
				"Roles": [
					{
						"Ref": "InstanceRole"
					}
				]
			}
		},
		"FortiAnalyzerSecGrp": {
			"Type": "AWS::EC2::SecurityGroup",
			"Properties": {
				"VpcId": {
					"Ref": "VPCID"
				},
				"GroupDescription": "FortiAnalyzerSecGrp",
				"SecurityGroupIngress": [
					{
						"Description": "Allow remote access to Faz",
						"IpProtocol": "-1",
						"FromPort": "0",
						"ToPort": "65535",
						"CidrIp": {
							"Ref": "CIDRForInstanceAccess"
						}
					},
					{
						"Description": "Allow local VPC access to Faz",
						"IpProtocol": "-1",
						"FromPort": "0",
						"ToPort": "65535",
						"CidrIp": {
							"Ref": "VPCCIDR"
						}
					},
					{
						"Description": "Allow 10.0.0.0/8 access to tcp port 541 Faz",
						"IpProtocol": "tcp",
						"FromPort": "541",
						"ToPort": "541",
						"CidrIp": "10.0.0.0/8"
					},
					{
						"Description": "Allow 172.16.0.0/12 access to tcp port 541 Faz",
						"IpProtocol": "tcp",
						"FromPort": "541",
						"ToPort": "541",
						"CidrIp": "172.16.0.0/12"
					},
					{
						"Description": "Allow 192.168.0.0/16 access to tcp port 541 Faz",
						"IpProtocol": "tcp",
						"FromPort": "541",
						"ToPort": "541",
						"CidrIp": "192.168.0.0/16"
					},
					{
						"Description": "Allow 10.0.0.0/8 access to tcp port 514 Faz",
						"IpProtocol": "tcp",
						"FromPort": "514",
						"ToPort": "514",
						"CidrIp": "10.0.0.0/8"
					},
					{
						"Description": "Allow 172.16.0.0/12 access to tcp port 514 Faz",
						"IpProtocol": "tcp",
						"FromPort": "514",
						"ToPort": "514",
						"CidrIp": "172.16.0.0/12"
					},
					{
						"Description": "Allow 192.168.0.0/16 access to tcp port 514 Faz",
						"IpProtocol": "tcp",
						"FromPort": "514",
						"ToPort": "514",
						"CidrIp": "192.168.0.0/16"
					},
					{
						"Description": "Allow 10.0.0.0/8 access to udp port 514 Faz",
						"IpProtocol": "udp",
						"FromPort": "514",
						"ToPort": "514",
						"CidrIp": "10.0.0.0/8"
					},
					{
						"Description": "Allow 172.16.0.0/12 access to udp port 514 Faz",
						"IpProtocol": "udp",
						"FromPort": "514",
						"ToPort": "514",
						"CidrIp": "172.16.0.0/12"
					},
					{
						"Description": "Allow 192.168.0.0/16 access to udp port 514 Faz",
						"IpProtocol": "udp",
						"FromPort": "514",
						"ToPort": "514",
						"CidrIp": "192.168.0.0/16"
					}
				]
			}
		},
		"Faz": {
			"Type": "AWS::EC2::Instance",
			"Properties": {
				"ImageId": {
					"Fn::GetAtt": [
						"RunImageFunction",
						"ami"
					]
				},
				"InstanceType": {
					"Ref": "InstanceType"
				},
				"IamInstanceProfile": {
					"Ref": "InstanceProfile"
				},
				"KeyName": {
					"Ref": "KeyPair"
				},
				"BlockDeviceMappings": [
					{
						"DeviceName": "/dev/sda1",
						"Ebs": {
							"VolumeType": "gp2",
							"VolumeSize": "5",
							"DeleteOnTermination": "true",
							"Encrypted": {
								"Ref": "EncryptVolumes"
							}
						}
					},
					{
						"DeviceName": "/dev/sdb",
						"Ebs": {
							"VolumeType": "gp2",
							"VolumeSize": "80",
							"DeleteOnTermination": "true",
							"Encrypted": {
								"Ref": "EncryptVolumes"
							}
						}
					}
				],
				"NetworkInterfaces": [
					{
						"NetworkInterfaceId": {
							"Ref": "FazEni0"
						},
						"DeviceIndex": "0"
					}
				],
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-FortiAnalyzer"
						}
					}
				],
				"UserData": {
					"Fn::Base64": {
						"Fn::If": [
							"BYOL",
							{
								"Fn::Sub": "{\"bucket\":\"${InitS3Bucket}\",\"region\":\"${AWS::Region}\",\"license\":\"/${FortiAnalyzerLicenseFile}\",\"config\":\"/faz-config.txt\"}"
							},
							{
								"Fn::Join": [
									"\n",
									[
										"Content-Type: multipart/mixed; boundary='==Boundary=='",
										"MIME-Version: 1.0",
										"",
										"--==Boundary==",
										"Content-Type: text/x-shellscript; charset='us-ascii'",
										"MIME-Version: 1.0",
										"",
										{
											"Fn::GetAtt": [
												"RunInitFunction",
												"faz_config"
											]
										},
										"config system global",
										{
											"Fn::Join": [
												"",
												[
													"set hostname ",
													{
														"Ref": "AWS::StackName"
													},
													"-Faz"
												]
											]
										},
										"end",
										"config system certificate ca",
										"edit 'AmazonRootCA1'",
										"set ca '-----BEGIN CERTIFICATE-----",
										"MIIDQTCCAimgAwIBAgITBmyfz5m/jAo54vB4ikPmljZbyjANBgkqhkiG9w0BAQsF",
										"ADA5MQswCQYDVQQGEwJVUzEPMA0GA1UEChMGQW1hem9uMRkwFwYDVQQDExBBbWF6",
										"b24gUm9vdCBDQSAxMB4XDTE1MDUyNjAwMDAwMFoXDTM4MDExNzAwMDAwMFowOTEL",
										"MAkGA1UEBhMCVVMxDzANBgNVBAoTBkFtYXpvbjEZMBcGA1UEAxMQQW1hem9uIFJv",
										"b3QgQ0EgMTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBALJ4gHHKeNXj",
										"ca9HgFB0fW7Y14h29Jlo91ghYPl0hAEvrAIthtOgQ3pOsqTQNroBvo3bSMgHFzZM",
										"9O6II8c+6zf1tRn4SWiw3te5djgdYZ6k/oI2peVKVuRF4fn9tBb6dNqcmzU5L/qw",
										"IFAGbHrQgLKm+a/sRxmPUDgH3KKHOVj4utWp+UhnMJbulHheb4mjUcAwhmahRWa6",
										"VOujw5H5SNz/0egwLX0tdHA114gk957EWW67c4cX8jJGKLhD+rcdqsq08p8kDi1L",
										"93FcXmn/6pUCyziKrlA4b9v7LWIbxcceVOF34GfID5yHI9Y/QCB/IIDEgEw+OyQm",
										"jgSubJrIqg0CAwEAAaNCMEAwDwYDVR0TAQH/BAUwAwEB/zAOBgNVHQ8BAf8EBAMC",
										"AYYwHQYDVR0OBBYEFIQYzIU07LwMlJQuCFmcx7IQTgoIMA0GCSqGSIb3DQEBCwUA",
										"A4IBAQCY8jdaQZChGsV2USggNiMOruYou6r4lK5IpDB/G/wkjUu0yKGX9rbxenDI",
										"U5PMCCjjmCXPI6T53iHTfIUJrU6adTrCC2qJeHZERxhlbI1Bjjt/msv0tadQ1wUs",
										"N+gDS63pYaACbvXy8MWy7Vu33PqUXHeeE6V/Uq2V8viTO96LXFvKWlJbYK8U90vv",
										"o/ufQJVtMVT8QtPHRh8jrdkPSHCa2XV4cdFyQzR1bldZwgJcJmApzyMZFo6IQ6XU",
										"5MsI+yMRQ+hDKXJioaldXgjUkK642M4UwtBV8ob2xJNDd2ZhwLnoQdeXeGADbkpy",
										"rqXRfboQnoZsG4q5WTP468SQvvG5",
										"-----END CERTIFICATE-----'",
										"set comment 'https://www.amazontrust.com/repository/'",
										"next",
										"edit 'AmazonRootCA2'",
										"set ca '-----BEGIN CERTIFICATE-----",
										"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",
										"4PsJYGw=",
										"-----END CERTIFICATE-----'",
										"set comment 'https://www.amazontrust.com/repository/'",
										"next",
										"edit 'AmazonRootCA3'",
										"set ca '-----BEGIN CERTIFICATE-----",
										"MIIBtjCCAVugAwIBAgITBmyf1XSXNmY/Owua2eiedgPySjAKBggqhkjOPQQDAjA5",
										"MQswCQYDVQQGEwJVUzEPMA0GA1UEChMGQW1hem9uMRkwFwYDVQQDExBBbWF6b24g",
										"Um9vdCBDQSAzMB4XDTE1MDUyNjAwMDAwMFoXDTQwMDUyNjAwMDAwMFowOTELMAkG",
										"A1UEBhMCVVMxDzANBgNVBAoTBkFtYXpvbjEZMBcGA1UEAxMQQW1hem9uIFJvb3Qg",
										"Q0EgMzBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IABCmXp8ZBf8ANm+gBG1bG8lKl",
										"ui2yEujSLtf6ycXYqm0fc4E7O5hrOXwzpcVOho6AF2hiRVd9RFgdszflZwjrZt6j",
										"QjBAMA8GA1UdEwEB/wQFMAMBAf8wDgYDVR0PAQH/BAQDAgGGMB0GA1UdDgQWBBSr",
										"ttvXBp43rDCGB5Fwx5zEGbF4wDAKBggqhkjOPQQDAgNJADBGAiEA4IWSoxe3jfkr",
										"BqWTrBqYaGFy+uGh0PsceGCmQ5nFuMQCIQCcAu/xlJyzlvnrxir4tiz+OpAUFteM",
										"YyRIHN8wfdVoOw==",
										"-----END CERTIFICATE-----'",
										"set comment 'https://www.amazontrust.com/repository/'",
										"next",
										"edit 'AmazonRootCA4'",
										"set ca '-----BEGIN CERTIFICATE-----",
										"MIIB8jCCAXigAwIBAgITBmyf18G7EEwpQ+Vxe3ssyBrBDjAKBggqhkjOPQQDAzA5",
										"MQswCQYDVQQGEwJVUzEPMA0GA1UEChMGQW1hem9uMRkwFwYDVQQDExBBbWF6b24g",
										"Um9vdCBDQSA0MB4XDTE1MDUyNjAwMDAwMFoXDTQwMDUyNjAwMDAwMFowOTELMAkG",
										"A1UEBhMCVVMxDzANBgNVBAoTBkFtYXpvbjEZMBcGA1UEAxMQQW1hem9uIFJvb3Qg",
										"Q0EgNDB2MBAGByqGSM49AgEGBSuBBAAiA2IABNKrijdPo1MN/sGKe0uoe0ZLY7Bi",
										"9i0b2whxIdIA6GO9mif78DluXeo9pcmBqqNbIJhFXRbb/egQbeOc4OO9X4Ri83Bk",
										"M6DLJC9wuoihKqB1+IGuYgbEgds5bimwHvouXKNCMEAwDwYDVR0TAQH/BAUwAwEB",
										"/zAOBgNVHQ8BAf8EBAMCAYYwHQYDVR0OBBYEFNPsxzplbszh2naaVvuc84ZtV+WB",
										"MAoGCCqGSM49BAMDA2gAMGUCMDqLIfG9fhGt0O9Yli/W651+kI0rz2ZVwyzjKKlw",
										"CkcO8DdZEv8tmZQoTipPNU0zWgIxAOp1AE47xDqUEpHJWEadIRNyp4iciuRMStuW",
										"1KyLa2tJElMzrdfkviT8tQp21KW8EA==",
										"-----END CERTIFICATE-----'",
										"set comment 'https://www.amazontrust.com/repository/'",
										"next",
										"edit 'SFSRootCAG2'",
										"set ca '-----BEGIN CERTIFICATE-----",
										"MIID7zCCAtegAwIBAgIBADANBgkqhkiG9w0BAQsFADCBmDELMAkGA1UEBhMCVVMx",
										"EDAOBgNVBAgTB0FyaXpvbmExEzARBgNVBAcTClNjb3R0c2RhbGUxJTAjBgNVBAoT",
										"HFN0YXJmaWVsZCBUZWNobm9sb2dpZXMsIEluYy4xOzA5BgNVBAMTMlN0YXJmaWVs",
										"ZCBTZXJ2aWNlcyBSb290IENlcnRpZmljYXRlIEF1dGhvcml0eSAtIEcyMB4XDTA5",
										"MDkwMTAwMDAwMFoXDTM3MTIzMTIzNTk1OVowgZgxCzAJBgNVBAYTAlVTMRAwDgYD",
										"VQQIEwdBcml6b25hMRMwEQYDVQQHEwpTY290dHNkYWxlMSUwIwYDVQQKExxTdGFy",
										"ZmllbGQgVGVjaG5vbG9naWVzLCBJbmMuMTswOQYDVQQDEzJTdGFyZmllbGQgU2Vy",
										"dmljZXMgUm9vdCBDZXJ0aWZpY2F0ZSBBdXRob3JpdHkgLSBHMjCCASIwDQYJKoZI",
										"hvcNAQEBBQADggEPADCCAQoCggEBANUMOsQq+U7i9b4Zl1+OiFOxHz/Lz58gE20p",
										"OsgPfTz3a3Y4Y9k2YKibXlwAgLIvWX/2h/klQ4bnaRtSmpDhcePYLQ1Ob/bISdm2",
										"8xpWriu2dBTrz/sm4xq6HZYuajtYlIlHVv8loJNwU4PahHQUw2eeBGg6345AWh1K",
										"Ts9DkTvnVtYAcMtS7nt9rjrnvDH5RfbCYM8TWQIrgMw0R9+53pBlbQLPLJGmpufe",
										"hRhJfGZOozptqbXuNC66DQO4M99H67FrjSXZm86B0UVGMpZwh94CDklDhbZsc7tk",
										"6mFBrMnUVN+HL8cisibMn1lUaJ/8viovxFUcdUBgF4UCVTmLfwUCAwEAAaNCMEAw",
										"DwYDVR0TAQH/BAUwAwEB/zAOBgNVHQ8BAf8EBAMCAQYwHQYDVR0OBBYEFJxfAN+q",
										"AdcwKziIorhtSpzyEZGDMA0GCSqGSIb3DQEBCwUAA4IBAQBLNqaEd2ndOxmfZyMI",
										"bw5hyf2E3F/YNoHN2BtBLZ9g3ccaaNnRbobhiCPPE95Dz+I0swSdHynVv/heyNXB",
										"ve6SbzJ08pGCL72CQnqtKrcgfU28elUSwhXqvfdqlS5sdJ/PHLTyxQGjhdByPq1z",
										"qwubdQxtRbeOlKyWN7Wg0I8VRw7j6IPdj/3vQQF3zCepYoUz8jcI73HPdwbeyBkd",
										"iEDPfUYd/x7H4c7/I9vG+o1VTqkC50cRRj70/b17KSa7qWFiNyi2LSr2EIZkyXCn",
										"0q23KXB56jzaYyWf/Wi3MOxw+3WKt21gZ7IeyLnp2KhvAotnDU0mV3HaIPzBSlCN",
										"sSi6",
										"-----END CERTIFICATE-----'",
										"set comment 'https://www.amazontrust.com/repository/'",
										"next",
										"end",
										"",
										{
											"Fn::If": [
												"FortiFlex",
												{
													"Fn::Sub": [
														"exec vm-license ${token}",
														{
															"token": {
																"Ref": "FortiAnalyzerFortiFlexToken"
															}
														}
													]
												},
												{
													"Ref": "AWS::NoValue"
												}
											]
										},
										"--==Boundary==--"
									]
								]
							}
						]
					}
				}
			}
		},
		"FazEni0": {
			"Type": "AWS::EC2::NetworkInterface",
			"Properties": {
				"Description": "port1",
				"GroupSet": [
					{
						"Ref": "FortiAnalyzerSecGrp"
					}
				],
				"SourceDestCheck": "false",
				"SubnetId": {
					"Ref": "Subnet"
				},
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-faz1eni0"
						}
					},
					{
						"Key": "Interface",
						"Value": "eth0"
					}
				],
				"PrivateIpAddresses": [
					{
						"PrivateIpAddress": {
							"Fn::Select": [
								"0",
								{
									"Fn::Split": [
										"/",
										{
											"Ref": "FortiAnalyzerIP"
										}
									]
								}
							]
						},
						"Primary": "true"
					}
				]
			}
		},
		"FazEIP": {
			"Type": "AWS::EC2::EIP",
			"Condition": "CreateEIP",
			"Properties": {
				"Domain": "vpc",
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-FortiAnalyzer"
						}
					}
				]
			}
		},
		"FazEIPASSOCIATION": {
			"Type": "AWS::EC2::EIPAssociation",
			"Condition": "CreateEIP",
			"Properties": {
				"AllocationId": {
					"Fn::GetAtt": [
						"FazEIP",
						"AllocationId"
					]
				},
				"NetworkInterfaceId": {
					"Ref": "FazEni0"
				},
				"PrivateIpAddress": {
					"Fn::Select": [
						"0",
						{
							"Fn::Split": [
								"/",
								{
									"Ref": "FortiAnalyzerIP"
								}
							]
						}
					]
				}
			},
			"DependsOn": [
				"Faz",
				"FazEni0",
				"FazEIP"
			]
		},
		"LambdaRole": {
			"Type": "AWS::IAM::Role",
			"Properties": {
				"AssumeRolePolicyDocument": {
					"Version": "2012-10-17",
					"Statement": [
						{
							"Effect": "Allow",
							"Principal": {
								"Service": [
									"lambda.amazonaws.com"
								]
							},
							"Action": [
								"sts:AssumeRole"
							]
						}
					]
				},
				"Path": "/",
				"Policies": [
					{
						"PolicyName": "S3AccessRole",
						"PolicyDocument": {
							"Version": "2012-10-17",
							"Statement": [
								{
									"Effect": "Allow",
									"Action": [
										"s3:PutObject",
										"ec2:DescribeImages"
									],
									"Resource": "*"
								},
								{
									"Effect": "Allow",
									"Action": [
										"logs:*"
									],
									"Resource": "*"
								}
							]
						}
					}
				]
			}
		},
		"ImageFunction": {
			"Type": "AWS::Lambda::Function",
			"Properties": {
				"Code": {
					"ZipFile": {
						"Fn::Join": [
							"\n",
							[
								"import boto3",
								"import cfnresponse",
								"import logging",
								"import json",
								"logger = logging.getLogger()",
								"logger.setLevel(logging.INFO)",
								"client = boto3.client('ec2')",
								"",
								"def handler(event, context):",
								"    if event['RequestType'] == 'Create':",
								"        logger.info('<-- event received: {}'.format(json.dumps(event)))",
								"        searchString = event['ResourceProperties']['SearchString']",
								"        productCode =  event['ResourceProperties']['ProductCode']",
								"    else:",
								"        responseData = {'msg':'200'}",
								"        cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData)",
								"        return None",
								"",
								"    try:",
								"        resp = client.describe_images(",
								"            Filters=[{'Name': 'name', 'Values': [searchString]}, {'Name': 'product-code', 'Values': [productCode]}],",
								"            Owners=['aws-marketplace']",
								"        )",
								"    except Exception as error:",
								"        logger.error('<--!! Exception: {}'.format(error))",
								"        responseData = {'msg':'Exception: {}'.format(error)}",
								"        cfnresponse.send(event, context, cfnresponse.FAILED, responseData)",
								"",
								"    if resp['ResponseMetadata']['HTTPStatusCode'] == 200 and resp['Images'] != []:",
								"        ami_dict = {}",
								"        ami_list = []",
								"        for entry in resp['Images']:",
								"            key = entry['CreationDate']",
								"            ami_dict[key] = entry['ImageId']",
								"        ami_list = sorted(ami_dict, reverse = True)",
								"        logger.info('--> found latest AMI: {}, {}, {} {}'.format(ami_dict[ami_list[0]], ami_list[0], searchString, productCode))",
								"        responseData = {'ami': ami_dict[ami_list[0]]}",
								"        cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData)",
								"    else:",
								"        logger.error('!!--> Unable to find AMI {} {} in describe_images response! {}'.format(searchString, productCode, resp))",
								"        responseData = {'msg':'Unable to find AMI {} {} in describe_images response! {}'.format(searchString, productCode,resp)}",
								"        cfnresponse.send(event, context, cfnresponse.FAILED, responseData)",
								""
							]
						]
					}
				},
				"Role": {
					"Fn::GetAtt": [
						"LambdaRole",
						"Arn"
					]
				},
				"Timeout": 120,
				"Handler": "index.handler",
				"Runtime": "python3.12",
				"MemorySize": 128
			}
		},
		"RunImageFunction": {
			"Type": "Custom::ImageFunction",
			"Properties": {
				"ServiceToken": {
					"Fn::GetAtt": [
						"ImageFunction",
						"Arn"
					]
				},
				"SearchString": {
					"Fn::Select": [
						"0",
						{
							"Fn::Split": [
								"|",
								{
									"Fn::FindInMap": [
										"FortiAnalyzerAMISearchString",
										{
											"Ref": "FortiAnalyzerVersion"
										},
										{
											"Ref": "LicenseType"
										}
									]
								}
							]
						}
					]
				},
				"ProductCode": {
					"Fn::Select": [
						"1",
						{
							"Fn::Split": [
								"|",
								{
									"Fn::FindInMap": [
										"FortiAnalyzerAMISearchString",
										{
											"Ref": "FortiAnalyzerVersion"
										},
										{
											"Ref": "LicenseType"
										}
									]
								}
							]
						}
					]
				}
			}
		},
		"InitFunction": {
			"Type": "AWS::Lambda::Function",
			"Properties": {
				"Code": {
					"ZipFile": {
						"Fn::Join": [
							"\n",
							[
								"import ast",
								"import boto3",
								"import cfnresponse",
								"import json",
								"import logging",
								"logger = logging.getLogger()",
								"logger.setLevel(logging.INFO)",
								"s3 = boto3.client('s3')",
								"",
								"template = '''\\",
								"config system admin setting",
								"set idle_timeout 60",
								"end",
								"config system interface",
								"edit port1",
								"set mode dhcp",
								"set allowaccess ping https",
								"next",
								{
									"Fn::If": [
										"BYOL",
										{
											"Fn::Join": [
												"\n",
												[
													"end",
													"config system global",
													{
														"Fn::Sub": "set hostname ${AWS::StackName}-Faz"
													},
													"end",
													"config system certificate ca",
													"edit 'AmazonRootCA1'",
													"set ca '-----BEGIN CERTIFICATE-----",
													"MIIDQTCCAimgAwIBAgITBmyfz5m/jAo54vB4ikPmljZbyjANBgkqhkiG9w0BAQsF",
													"ADA5MQswCQYDVQQGEwJVUzEPMA0GA1UEChMGQW1hem9uMRkwFwYDVQQDExBBbWF6",
													"b24gUm9vdCBDQSAxMB4XDTE1MDUyNjAwMDAwMFoXDTM4MDExNzAwMDAwMFowOTEL",
													"MAkGA1UEBhMCVVMxDzANBgNVBAoTBkFtYXpvbjEZMBcGA1UEAxMQQW1hem9uIFJv",
													"b3QgQ0EgMTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBALJ4gHHKeNXj",
													"ca9HgFB0fW7Y14h29Jlo91ghYPl0hAEvrAIthtOgQ3pOsqTQNroBvo3bSMgHFzZM",
													"9O6II8c+6zf1tRn4SWiw3te5djgdYZ6k/oI2peVKVuRF4fn9tBb6dNqcmzU5L/qw",
													"IFAGbHrQgLKm+a/sRxmPUDgH3KKHOVj4utWp+UhnMJbulHheb4mjUcAwhmahRWa6",
													"VOujw5H5SNz/0egwLX0tdHA114gk957EWW67c4cX8jJGKLhD+rcdqsq08p8kDi1L",
													"93FcXmn/6pUCyziKrlA4b9v7LWIbxcceVOF34GfID5yHI9Y/QCB/IIDEgEw+OyQm",
													"jgSubJrIqg0CAwEAAaNCMEAwDwYDVR0TAQH/BAUwAwEB/zAOBgNVHQ8BAf8EBAMC",
													"AYYwHQYDVR0OBBYEFIQYzIU07LwMlJQuCFmcx7IQTgoIMA0GCSqGSIb3DQEBCwUA",
													"A4IBAQCY8jdaQZChGsV2USggNiMOruYou6r4lK5IpDB/G/wkjUu0yKGX9rbxenDI",
													"U5PMCCjjmCXPI6T53iHTfIUJrU6adTrCC2qJeHZERxhlbI1Bjjt/msv0tadQ1wUs",
													"N+gDS63pYaACbvXy8MWy7Vu33PqUXHeeE6V/Uq2V8viTO96LXFvKWlJbYK8U90vv",
													"o/ufQJVtMVT8QtPHRh8jrdkPSHCa2XV4cdFyQzR1bldZwgJcJmApzyMZFo6IQ6XU",
													"5MsI+yMRQ+hDKXJioaldXgjUkK642M4UwtBV8ob2xJNDd2ZhwLnoQdeXeGADbkpy",
													"rqXRfboQnoZsG4q5WTP468SQvvG5",
													"-----END CERTIFICATE-----'",
													"set comment 'https://www.amazontrust.com/repository/'",
													"next",
													"edit 'AmazonRootCA2'",
													"set ca '-----BEGIN CERTIFICATE-----",
													"MIIFQTCCAymgAwIBAgITBmyf0pY1hp8KD+WGePhbJruKNzANBgkqhkiG9w0BAQwF",
													"ADA5MQswCQYDVQQGEwJVUzEPMA0GA1UEChMGQW1hem9uMRkwFwYDVQQDExBBbWF6",
													"b24gUm9vdCBDQSAyMB4XDTE1MDUyNjAwMDAwMFoXDTQwMDUyNjAwMDAwMFowOTEL",
													"MAkGA1UEBhMCVVMxDzANBgNVBAoTBkFtYXpvbjEZMBcGA1UEAxMQQW1hem9uIFJv",
													"b3QgQ0EgMjCCAiIwDQYJKoZIhvcNAQEBBQADggIPADCCAgoCggIBAK2Wny2cSkxK",
													"gXlRmeyKy2tgURO8TW0G/LAIjd0ZEGrHJgw12MBvIITplLGbhQPDW9tK6Mj4kHbZ",
													"W0/jTOgGNk3Mmqw9DJArktQGGWCsN0R5hYGCrVo34A3MnaZMUnbqQ523BNFQ9lXg",
													"1dKmSYXpN+nKfq5clU1Imj+uIFptiJXZNLhSGkOQsL9sBbm2eLfq0OQ6PBJTYv9K",
													"8nu+NQWpEjTj82R0Yiw9AElaKP4yRLuH3WUnAnE72kr3H9rN9yFVkE8P7K6C4Z9r",
													"2UXTu/Bfh+08LDmG2j/e7HJV63mjrdvdfLC6HM783k81ds8P+HgfajZRRidhW+me",
													"z/CiVX18JYpvL7TFz4QuK/0NURBs+18bvBt+xa47mAExkv8LV/SasrlX6avvDXbR",
													"8O70zoan4G7ptGmh32n2M8ZpLpcTnqWHsFcQgTfJU7O7f/aS0ZzQGPSSbtqDT6Zj",
													"mUyl+17vIWR6IF9sZIUVyzfpYgwLKhbcAS4y2j5L9Z469hdAlO+ekQiG+r5jqFoz",
													"7Mt0Q5X5bGlSNscpb/xVA1wf+5+9R+vnSUeVC06JIglJ4PVhHvG/LopyboBZ/1c6",
													"+XUyo05f7O0oYtlNc/LMgRdg7c3r3NunysV+Ar3yVAhU/bQtCSwXVEqY0VThUWcI",
													"0u1ufm8/0i2BWSlmy5A5lREedCf+3euvAgMBAAGjQjBAMA8GA1UdEwEB/wQFMAMB",
													"Af8wDgYDVR0PAQH/BAQDAgGGMB0GA1UdDgQWBBSwDPBMMPQFWAJI/TPlUq9LhONm",
													"UjANBgkqhkiG9w0BAQwFAAOCAgEAqqiAjw54o+Ci1M3m9Zh6O+oAA7CXDpO8Wqj2",
													"LIxyh6mx/H9z/WNxeKWHWc8w4Q0QshNabYL1auaAn6AFC2jkR2vHat+2/XcycuUY",
													"+gn0oJMsXdKMdYV2ZZAMA3m3MSNjrXiDCYZohMr/+c8mmpJ5581LxedhpxfL86kS",
													"k5Nrp+gvU5LEYFiwzAJRGFuFjWJZY7attN6a+yb3ACfAXVU3dJnJUH/jWS5E4ywl",
													"7uxMMne0nxrpS10gxdr9HIcWxkPo1LsmmkVwXqkLN1PiRnsn/eBG8om3zEK2yygm",
													"btmlyTrIQRNg91CMFa6ybRoVGld45pIq2WWQgj9sAq+uEjonljYE1x2igGOpm/Hl",
													"urR8FLBOybEfdF849lHqm/osohHUqS0nGkWxr7JOcQ3AWEbWaQbLU8uz/mtBzUF+",
													"fUwPfHJ5elnNXkoOrJupmHN5fLT0zLm4BwyydFy4x2+IoZCn9Kr5v2c69BoVYh63",
													"n749sSmvZ6ES8lgQGVMDMBu4Gon2nL2XA46jCfMdiyHxtN/kHNGfZQIG6lzWE7OE",
													"76KlXIx3KadowGuuQNKotOrN8I1LOJwZmhsoVLiJkO/KdYE+HvJkJMcYr07/R54H",
													"9jVlpNMKVv/1F2Rs76giJUmTtt8AF9pYfl3uxRuw0dFfIRDH+fO6AgonB8Xx1sfT",
													"4PsJYGw=",
													"-----END CERTIFICATE-----'",
													"set comment 'https://www.amazontrust.com/repository/'",
													"next",
													"edit 'AmazonRootCA3'",
													"set ca '-----BEGIN CERTIFICATE-----",
													"MIIBtjCCAVugAwIBAgITBmyf1XSXNmY/Owua2eiedgPySjAKBggqhkjOPQQDAjA5",
													"MQswCQYDVQQGEwJVUzEPMA0GA1UEChMGQW1hem9uMRkwFwYDVQQDExBBbWF6b24g",
													"Um9vdCBDQSAzMB4XDTE1MDUyNjAwMDAwMFoXDTQwMDUyNjAwMDAwMFowOTELMAkG",
													"A1UEBhMCVVMxDzANBgNVBAoTBkFtYXpvbjEZMBcGA1UEAxMQQW1hem9uIFJvb3Qg",
													"Q0EgMzBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IABCmXp8ZBf8ANm+gBG1bG8lKl",
													"ui2yEujSLtf6ycXYqm0fc4E7O5hrOXwzpcVOho6AF2hiRVd9RFgdszflZwjrZt6j",
													"QjBAMA8GA1UdEwEB/wQFMAMBAf8wDgYDVR0PAQH/BAQDAgGGMB0GA1UdDgQWBBSr",
													"ttvXBp43rDCGB5Fwx5zEGbF4wDAKBggqhkjOPQQDAgNJADBGAiEA4IWSoxe3jfkr",
													"BqWTrBqYaGFy+uGh0PsceGCmQ5nFuMQCIQCcAu/xlJyzlvnrxir4tiz+OpAUFteM",
													"YyRIHN8wfdVoOw==",
													"-----END CERTIFICATE-----'",
													"set comment 'https://www.amazontrust.com/repository/'",
													"next",
													"edit 'AmazonRootCA4'",
													"set ca '-----BEGIN CERTIFICATE-----",
													"MIIB8jCCAXigAwIBAgITBmyf18G7EEwpQ+Vxe3ssyBrBDjAKBggqhkjOPQQDAzA5",
													"MQswCQYDVQQGEwJVUzEPMA0GA1UEChMGQW1hem9uMRkwFwYDVQQDExBBbWF6b24g",
													"Um9vdCBDQSA0MB4XDTE1MDUyNjAwMDAwMFoXDTQwMDUyNjAwMDAwMFowOTELMAkG",
													"A1UEBhMCVVMxDzANBgNVBAoTBkFtYXpvbjEZMBcGA1UEAxMQQW1hem9uIFJvb3Qg",
													"Q0EgNDB2MBAGByqGSM49AgEGBSuBBAAiA2IABNKrijdPo1MN/sGKe0uoe0ZLY7Bi",
													"9i0b2whxIdIA6GO9mif78DluXeo9pcmBqqNbIJhFXRbb/egQbeOc4OO9X4Ri83Bk",
													"M6DLJC9wuoihKqB1+IGuYgbEgds5bimwHvouXKNCMEAwDwYDVR0TAQH/BAUwAwEB",
													"/zAOBgNVHQ8BAf8EBAMCAYYwHQYDVR0OBBYEFNPsxzplbszh2naaVvuc84ZtV+WB",
													"MAoGCCqGSM49BAMDA2gAMGUCMDqLIfG9fhGt0O9Yli/W651+kI0rz2ZVwyzjKKlw",
													"CkcO8DdZEv8tmZQoTipPNU0zWgIxAOp1AE47xDqUEpHJWEadIRNyp4iciuRMStuW",
													"1KyLa2tJElMzrdfkviT8tQp21KW8EA==",
													"-----END CERTIFICATE-----'",
													"set comment 'https://www.amazontrust.com/repository/'",
													"next",
													"edit 'SFSRootCAG2'",
													"set ca '-----BEGIN CERTIFICATE-----",
													"MIID7zCCAtegAwIBAgIBADANBgkqhkiG9w0BAQsFADCBmDELMAkGA1UEBhMCVVMx",
													"EDAOBgNVBAgTB0FyaXpvbmExEzARBgNVBAcTClNjb3R0c2RhbGUxJTAjBgNVBAoT",
													"HFN0YXJmaWVsZCBUZWNobm9sb2dpZXMsIEluYy4xOzA5BgNVBAMTMlN0YXJmaWVs",
													"ZCBTZXJ2aWNlcyBSb290IENlcnRpZmljYXRlIEF1dGhvcml0eSAtIEcyMB4XDTA5",
													"MDkwMTAwMDAwMFoXDTM3MTIzMTIzNTk1OVowgZgxCzAJBgNVBAYTAlVTMRAwDgYD",
													"VQQIEwdBcml6b25hMRMwEQYDVQQHEwpTY290dHNkYWxlMSUwIwYDVQQKExxTdGFy",
													"ZmllbGQgVGVjaG5vbG9naWVzLCBJbmMuMTswOQYDVQQDEzJTdGFyZmllbGQgU2Vy",
													"dmljZXMgUm9vdCBDZXJ0aWZpY2F0ZSBBdXRob3JpdHkgLSBHMjCCASIwDQYJKoZI",
													"hvcNAQEBBQADggEPADCCAQoCggEBANUMOsQq+U7i9b4Zl1+OiFOxHz/Lz58gE20p",
													"OsgPfTz3a3Y4Y9k2YKibXlwAgLIvWX/2h/klQ4bnaRtSmpDhcePYLQ1Ob/bISdm2",
													"8xpWriu2dBTrz/sm4xq6HZYuajtYlIlHVv8loJNwU4PahHQUw2eeBGg6345AWh1K",
													"Ts9DkTvnVtYAcMtS7nt9rjrnvDH5RfbCYM8TWQIrgMw0R9+53pBlbQLPLJGmpufe",
													"hRhJfGZOozptqbXuNC66DQO4M99H67FrjSXZm86B0UVGMpZwh94CDklDhbZsc7tk",
													"6mFBrMnUVN+HL8cisibMn1lUaJ/8viovxFUcdUBgF4UCVTmLfwUCAwEAAaNCMEAw",
													"DwYDVR0TAQH/BAUwAwEB/zAOBgNVHQ8BAf8EBAMCAQYwHQYDVR0OBBYEFJxfAN+q",
													"AdcwKziIorhtSpzyEZGDMA0GCSqGSIb3DQEBCwUAA4IBAQBLNqaEd2ndOxmfZyMI",
													"bw5hyf2E3F/YNoHN2BtBLZ9g3ccaaNnRbobhiCPPE95Dz+I0swSdHynVv/heyNXB",
													"ve6SbzJ08pGCL72CQnqtKrcgfU28elUSwhXqvfdqlS5sdJ/PHLTyxQGjhdByPq1z",
													"qwubdQxtRbeOlKyWN7Wg0I8VRw7j6IPdj/3vQQF3zCepYoUz8jcI73HPdwbeyBkd",
													"iEDPfUYd/x7H4c7/I9vG+o1VTqkC50cRRj70/b17KSa7qWFiNyi2LSr2EIZkyXCn",
													"0q23KXB56jzaYyWf/Wi3MOxw+3WKt21gZ7IeyLnp2KhvAotnDU0mV3HaIPzBSlCN",
													"sSi6",
													"-----END CERTIFICATE-----'",
													"set comment 'https://www.amazontrust.com/repository/'",
													"next",
													"end\\"
												]
											]
										},
										{
											"Fn::Join": [
												"\n",
												[
													"end\\"
												]
											]
										}
									]
								},
								"'''",
								"",
								"def handler(event, context):",
								"    if event['RequestType'] == 'Create':",
								"        logger.info('<-- event received: {}'.format(json.dumps(event)))",
								"    else:",
								"        responseData = {'msg':'200'}",
								"        cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData)",
								"        return None",
								"",
								{
									"Fn::If": [
										"BYOL",
										{
											"Fn::Join": [
												"\n",
												[
													"    try:",
													"        response = s3.put_object(Body=template, Bucket=event['ResourceProperties']['S3Bucket'], Key='faz-config.txt')",
													"    except Exception as error:",
													"        logger.error('<--!! Exception: {}'.format(error))",
													"        responseData = {'msg':'Exception: {}'.format(error)}",
													"        cfnresponse.send(event, context, cfnresponse.FAILED, responseData)",
													"        return None",
													"",
													"    if response['ResponseMetadata']['HTTPStatusCode'] == 200:",
													"        logger.info('<-- s3 put_object faz-config.txt successful')",
													"        responseData = {'msg':'success'}",
													"        cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData)",
													"    else:",
													"        responseData = {'msg':'error'}",
													"        cfnresponse.send(event, context, cfnresponse.FAILED, responseData)",
													""
												]
											]
										},
										{
											"Fn::Join": [
												"\n",
												[
													"    responseData = {'faz_config':template}",
													"    cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData)",
													""
												]
											]
										}
									]
								}
							]
						]
					}
				},
				"Role": {
					"Fn::GetAtt": [
						"LambdaRole",
						"Arn"
					]
				},
				"Timeout": 120,
				"Handler": "index.handler",
				"Runtime": "python3.12",
				"MemorySize": 128
			}
		},
		"RunInitFunction": {
			"Type": "Custom::InitFunction",
			"Properties": {
				"ServiceToken": {
					"Fn::GetAtt": [
						"InitFunction",
						"Arn"
					]
				},
				"S3Bucket": {
					"Ref": "InitS3Bucket"
				}
			}
		}
	},
	"Outputs": {
		"Username": {
			"Value": "admin",
			"Description": "Username for the FortiAnalyzers"
		},
		"Password": {
			"Value": {
				"Ref": "Faz"
			},
			"Description": "Initial password for the FortiAnalyzer"
		},
		"FortiAnalyzerLoginURL": {
			"Value": {
				"Fn::Sub": [
					"https://${IP}",
					{
						"IP": {
							"Fn::If": [
								"CreateEIP",
								{
									"Ref": "FazEIP"
								},
								{
									"Fn::GetAtt": [
										"FazEni0",
										"PrimaryPrivateIpAddress"
									]
								}
							]
						}
					}
				]
			},
			"Description": "Login URL for FortiAnalyzer"
		}
	}
}